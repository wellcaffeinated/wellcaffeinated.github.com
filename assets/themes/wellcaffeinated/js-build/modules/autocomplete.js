define(["jquery","plugins/tpl!templates/autocomplete.tpl","modules/caret"],function(e,t){function n(e,t,n){var r,i;n.createTextRange?(r=t-e,i=n.createTextRange(),i.collapse(!0),i.moveStart("character",e),i.moveEnd("character",r),i.select()):n.setSelectionRange&&n.setSelectionRange(e,t)}function r(e,t){var n=t,r=t;while(n>0&&e[n-1]!=" ")n--;while(r<e.length&&e[r]!=" ")r++;return{start:n,end:r}}function i(e){this.setOptions(e),this.init()}function s(e){return new i(e)}return i.prototype={classNames:{input:"autocomplete-input-box",selected:"on"},init:function(){this.cache={},this.to={},this.blacklist=[],this.queryData={},this.el=e(this.config.el).first();if(!this.el.length)throw"HTMLElement for autocomplete not valid.";this.el.attr("autocomplete","off").addClass(this.classNames.input),this.url=this.el.attr("data-autocomplete-url"),this.elResults=e('<div class="'+this.config.resultsClassName+'">').hide().css("position","absolute"),e("body").append(this.elResults),this.enableMouseEvents(),this.bindEvents()},setOptions:function(t){this.config=e.extend(this.config||{el:null,submit:e.noop,minQueryLength:0,delay:400,align:"left",resultsClassName:"autocomplete-results",submitOnSelect:!0,usePartialComplete:!0,hintOnFocus:!0,useBlacklist:!0,itemClassName:"item",show:function(){e(this).show()},hide:function(){e(this).hide()}},t)},positionResults:function(){var t=this.el.offset(),n=this.config.align;this.elResults.css("top",t.top+this.el.outerHeight()).css(n,n==="left"?t[n]:e("body").width()-t.left-this.el.outerWidth())},bindEvents:function(){var t=this;this.el.on({focus:function(e){var r=this,i;setTimeout(function(){i=r.value.length,n(i-1,i-1,t.el[0]),n(i,i,t.el[0])},100)},select:function(e){t.to.activate&&(clearTimeout(t.to.activate),t.deactivate())},mouseup:function(e){t.el.val().length>0&&(t.doSelect=!0,t.activate(20))},touchend:function(e){t.el.val().length>0&&(t.doSelect=!0,t.activate(20))},keydown:function(e){t.lastKeyPressed=e.keyCode,t.doSelect=!1;switch(t.lastKeyPressed){case 38:t.active?t.focusPrev():t.activate(!0);break;case 40:t.active?t.focusNext():t.activate(!0);break;case 9:if(!t.active)return!0;t.selectCurrent(!0);break;case 13:t.active?t.selectCurrent(!t.config.submitOnSelect):t.submit();break;case 27:if(!t.active)return!0;t.el.val(t.getSuggestQuery().oldText),t.deactivate();break;default:return t.activate(),!0}return e.preventDefault(),!1}}),this.elResults.on({mouseenter:function(e){if(t.noMouse)return;if(t.disableMouseEnter){t.disableMouseEnter--;return}t.focusItem(this)},click:function(e){e.preventDefault();if(t.noMouse)return;t.focusItem(this),t.selectCurrent(!t.config.submitOnSelect),t.el.focus(),t.disableMouseEnter=1}},"."+this.config.itemClassName),e(document).on("click",function(e){var n=e.target;!t.elResults.is(n)&&!t.el.is(n)&&!t.elResults.has(n).length&&t.deactivate()})},selectSuggestQuery:function(){var e=this,t=e.getSuggestQuery();n(t.start,t.start+1,this.el[0]),setTimeout(function(){n(t.start,t.end,e.el[0])},10)},getSuggestQuery:function(e){if(!e)return this.queryData;var t=this.el.caret().start,n,i;return this.queryData.oldText=this.el.val(),n=this.queryData.oldText.replace(/\s+$/,""),!this.config.usePartialComplete||t>=n.length?(this.queryData.start=0,this.queryData.end=this.queryData.oldText.length,this.queryData.query=n):(i=r(n,t),this.queryData.start=i.start,this.queryData.end=i.end,this.queryData.query=n.substring(i.start,i.end)),this.queryData},activate:function(e){function n(){var e=t.getSuggestQuery(!0).query;t.focusedItem=-1,e.length>t.config.minQueryLength&&t.fetchResults(e,function(n){n&&t.showResults(n,e)})}var t=this;t.to.activate&&clearTimeout(t.to.activate),t.ajaxRequest&&t.ajaxRequest.abort(),e===!0?n():t.to.activate=setTimeout(n,e||t.config.delay)},deactivate:function(){this.focusedItem=null,this.hideResults()},fetchResults:function(t,n){var r=this,i=r.cache[t];if(i)n(i);else{if(r.isBlacklisted(t)){r.deactivate();return}r.ajaxRequest=e.ajax({url:r.url+(r.url.indexOf("?")!==-1?"&":"?")+encodeURIComponent(r.el.attr("name"))+"="+encodeURIComponent(t),dataType:"json",success:function(e){i=e,r.cache[t]=i,n(i)},error:function(){n(!1)}})}},isBlacklisted:function(e){if(this.config.useBlacklist===!1)return!1;for(var t in this.blacklist)if(e.indexOf(this.blacklist[t])===0)return!0;return!1},showResults:function(e,n){var r=this;r.elResults.html(t.render(e));if(e&&r.elResults.find("."+r.config.itemClassName).length===0){r.config.useBlacklist&&r.blacklist.push(n),r.deactivate();return}r.positionResults(),r.doSelect&&n!==r.el.val().replace(/\s+$/,"")&&r.selectSuggestQuery(),r.config.show.apply(r.elResults[0]),r.active=!0},hideResults:function(){var e=this;e.config.hide.apply(e.elResults[0]),e.active=!1},submit:function(){this.config.submit.apply(this.el[0])},focusNext:function(){this.focusItem(this.focusedItem+1)},focusPrev:function(){this.focusItem(this.focusedItem-1)},focusItem:function(t){var n=this.elResults.find("."+this.config.itemClassName),r;typeof t=="number"?(t<0?t=0:t>=n.length&&(t=n.length-1),r=n.eq(t)):r=e(t),n.removeClass(this.classNames.selected),r.addClass(this.classNames.selected),this.focusedItem=r.index(),this.config.hintOnFocus&&this.hintSuggestion()},hintSuggestion:function(){var e,t,r,i=this.getSuggestQuery(),s="",o=0;if(this.focusedItem>=0){e=this.elResults.find("."+this.config.itemClassName+":eq("+this.focusedItem+")"),t=e.find(".sug"),s=t.length?t.text():e.text(),r=s.length,this.el.val(i.oldText.replace(i.query,s));while(o<s.length&&i.query[o]===s[o])o++;n(i.start+o,i.start+r,this.el[0])}},selectCurrent:function(e){var t,n,r=this.getSuggestQuery(),i="";if(this.focusedItem>=0){t=this.elResults.find("."+this.config.itemClassName+":eq("+this.focusedItem+")"),n=t.find(".sug"),i=n.length?n.text():t.text(),i=r.oldText.replace(r.query,i).replace(/\s+$/,""),i+=e?" ":"",this.el.val(i);if(e){this.activate(!0);return}}this.deactivate(),this.submit()},disableMouseEvents:function(){this.noMouse=!0},enableMouseEvents:function(){this.noMouse=!1}},s})